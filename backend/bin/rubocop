#!/bin/bash

set -eu
cd $(readlink -f $0 | xargs dirname)/..

NETCAT="nc -N" # 環境に応じて調整
DAEMON_DIR="tmp/rubocop-daemon"

ARGS=$(echo "$@" | sed "s|$PWD|\.|")
COMMAND="$(cat $DAEMON_DIR/token) /app exec $ARGS"

# 標準入力を読み取っておく; vscodeは'-s'オプション付きで実行するため
STDIN_CONTENT="$(cat)"

printf '%s\n%s\n' "$COMMAND" "$STDIN_CONTENT" | $NETCAT 127.0.0.1 $(cat $DAEMON_DIR/port)

exit $(cat $DAEMON_DIR/status)
